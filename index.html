

<!DOCTYPE html>
<html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Color Shooter</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class = "center">
        <div>
            <div class = "color" id = "blue" style = "background-color : blue;">
            </div>
            <div class = "color" id = "red" style = "background-color : red;">
            </div>
            <div class = "color" id = "green" style = "background-color : green;">
            </div>
            <div class = "color highlight" id = "yellow" style = "background-color : yellow;">
            </div>
        </div>
    </div>
    <canvas id="gc" width="1000" height="500" ></canvas>
    <div style="bottom:0">
    </div>
    <script src="./player.js"></script>
    <script src="./enemy.js"></script>
    <script src="./bullet.js"></script>
    <script>
    window.onload=function() {
        canv=document.getElementById("gc");
        ctx=canv.getContext("2d");
        document.addEventListener("keydown",keyPush);
        document.addEventListener("keyup", keyUp);
        canv.addEventListener("mousedown", shoot);
        game = setInterval(game,1000/60);
        bounding = canv.getBoundingClientRect();
    }

    
    var animationArr = []; //dying enemies
    var bulletArr = [];
    var enemyArr = [];
    const colors = [
        "blue",
        "red",
        "green",
        "yellow"
    ]
    colors.blue = 0;
    colors.red = 1;
    colors.green = 2;
    colors.yellow = 3;

    const variants = [
        "spaz",
        "charge"
    ]

    function addHighlight(color)
    {
        document.getElementById("red").classList.remove("highlight");
        document.getElementById("yellow").classList.remove("highlight");
        document.getElementById("blue").classList.remove("highlight");
        document.getElementById("green").classList.remove("highlight");

        document.getElementById(color).classList.add("highlight");
    }

    var player = new Player("yellow", 70, 70, 5);
    var px = 500;
    var py = 250;
    var vx = 0;
    var vy = 0;
    var keys ={"w":false, "a":false, "s":false, "d":false};
    var spawnTimer = 50;
    spawnEnemies(5);

    function game ()
    {   vMove();
        px += (vx * player.getSpeed());
        px = px + player.sizex > canv.width ? canv.width - player.sizex : px;
        px = px < 0 ? 0 : px;

        py += (vy * player.getSpeed());
        py = py + player.sizey > canv.height ? canv.height - player.sizey : py;
        py = py < 0 ? 0 : py;

        ctx.fillStyle="white";
        ctx.fillRect(0,0,canv.width,canv.height);
        
        let size = player.getSize();
        ctx.fillStyle = "black";
        ctx.fillRect(px, py, size.sx, size.sy);
        ctx.fillStyle = player.getColor();
        ctx.fillRect(px+2,py+2,size.sx-4, size.sy-4);
        
        let aliveEnemies = [];
        for (let i = 0; i < enemyArr.length; i ++)
        {
            if (!enemyArr[i].dead)
            {
                ctx.fillStyle = enemyArr[i].color;
                let move = enemyArr[i].makeMove(px + player.sizex / 2, py + player.sizey / 2, bulletArr);
                move[0] = move[0] + move[2] > canv.width ? canv.width - move[2] : move[0];
                move[0] = move[0] < 0 ? 0 : move[0];

                move[1] = move[1] + move[3] > canv.height ? canv.height - move[3] : move[1];
                move[1] = move[1] < 0 ? 0 : move[1];

                ctx.fillRect(move[0], move[1], move[2], move[3]);
                enemyArr[i].move(move[0], move[1]);

                aliveEnemies.push(enemyArr[i]);
            }
        }

        let bouncingBullets = [];
        for(let i =0; i<bulletArr.length; i++){
            let move = bulletArr[i].makeMove();

            //x
            if (move[0] + 7 > canv.width || move[0] < 0)
            {
                bulletArr[i].grace = 0;
                bulletArr[i].tx *= -1;
                bulletArr[i].bounce ++;
            }
            //y
            if (move[1] + 7 > canv.height || move[1] < 0)
            {
                bulletArr[i].grace = 0;
                bulletArr[i].ty *= -1;
                bulletArr[i].bounce ++;
            }
            if (bulletArr[i].bounce < 5)
            {
                ctx.fillStyle = "black";
                ctx.fillRect(move[0], move[1], 7, 7);
                ctx.fillStyle = bulletArr[i].getColor();
                ctx.fillRect(move[0]+1, move[1]+1, 5, 5);
                bulletArr[i].move(move[0],move[1]);
                bouncingBullets.push(bulletArr[i]);
            }
            bulletArr[i].grace -= 1;
        }
        bulletArr = bouncingBullets;




        //check enemy collide bullet
        for (let i = 0; i < bulletArr.length; i ++)
        {
            for (let p = 0; p < enemyArr.length; p ++)
            {
                if (
                    Math.max(bulletArr[i].x, enemyArr[p].x) <= Math.min(bulletArr[i].x + 7, enemyArr[p].x + enemyArr[p].size) 
                &&  Math.max(bulletArr[i].y, enemyArr[p].y) <= Math.min(bulletArr[i].y + 7, enemyArr[p].y + enemyArr[p].size) &&
                    bulletArr[i].getColor() === enemyArr[p].color 
                    )
                {
                    enemyArr[p].dead = true;
                }
            }
        }
        
        bouncingBullets = []
        for(let i = 0; i < bulletArr.length; i++){
            console.log(bulletArr[i]);
            if(
                Math.max(bulletArr[i].x, px) <= Math.min(bulletArr[i].x + 7, px + player.sizex)
                && Math.max(bulletArr[i].y, py) <= Math.min(bulletArr[i].y + 7, py + player.sizey) && bulletArr[i].grace < 1
            ){
                if(bulletArr[i].color === player.color)
                    player.grow();
                else{
                    clearInterval(game);
                    ctx.fillStyle = "white";
                    ctx.fillRect(px-1, py-1, player.sizex+2, player.sizey+2);
                }
            }
            else{
                bouncingBullets.push(bulletArr[i])
            }
        }
        bulletArr = bouncingBullets;

        for(let i = 0; i < enemyArr.length; i++){
            if(
                Math.max(enemyArr[i].x, px) <= Math.min(enemyArr[i].x + 7, px + player.sizex)
                && Math.max(enemyArr[i].y, py) <= Math.min(enemyArr[i].y + 7, py + player.sizey)
            ){
            clearInterval(game);
            ctx.fillStyle = "white";
            ctx.fillRect(px-1, py-1, player.sizex+2, player.sizey+2);}
        }
    }

    function keyPush(evt) {
        console.log(evt.key)
        switch(evt.key) {
            case 'a':
                keys.a = true;
                break;
            case 's':
                keys.s = true;
                break;
            case 'd':
                keys.d = true;
                break;
            case 'w':
                keys.w = true;
                break;
        }
    }

    function keyUp(evt){
        switch(evt.key) {
            case 'a':
                keys.a = false;
                vx=0;
                break;
            case 'w':
                keys.w = false;
                vy=0;
                break;
            case 'd':
                keys.d =false;
                vx=0;
                break;
            case 's':
                keys.s = false;
                vy = 0;
                break;
            case '1':
                player.setColor("blue");
                addHighlight("blue");
                break;
            case '2':
                player.setColor("red");
                addHighlight("red");
                break;
            case '3':
                player.setColor("green");
                addHighlight("green");
                break;
            case '4':
                player.setColor("yellow");
                addHighlight("yellow");
                break;
            case 'e':
                let index = colors[player.getColor()] + 1;
                index = index === colors.length ? 0 : index;
                player.setColor(colors[index]);
                addHighlight(colors[index]);
                break;
            case 'q':
                let index2 = colors[player.getColor()] - 1;
                index2 = index2 === -1 ? colors.length - 1 : index2;
                player.setColor(colors[index2]);
                addHighlight(colors[index2]);
            
        }
    };

    function spawnEnemies(numEnemies)
    {
        for (var i = 0; i < numEnemies; i ++)
        {
            //enemy constructor
            //constructor(difficulty, color, size, positionx, positiony, variant)
            let color = colors[Math.floor(Math.random() * colors.length)];
            //let variant = variants[Math.floor(Math.random() * variants.length)];
            let variant = "dodge";
            enemyArr.push(new Enemy(4, color, 30, 250, 250, variant));
        }
    }

    function shoot(evt){
        if(player.sizex > 7){
        //mouse position
        mx = evt.clientX - bounding.left;
        my = evt.clientY - bounding.top;
        //bullet origin position (Player center);
        originx = px + player.sizex / 2;
        originy = py + player.sizey / 2;
        a = mx - originx;
        b = my - originy;
        bullet = new Bullet(player.getColor(),originx,originy, a/50, b/50);
        player.shrink();
        bulletArr.push(bullet);
    }
}


function vMove(){
        if(keys.a && keys.d)
            vx = 0;
        else if(keys.a)
            vx = -1;
        else if(keys.d)
            vx = 1
        if(keys.w && keys.s)
            vy =0;
        else if(keys.w)
            vy = -1;
        else if(keys.s)
            vy = 1; 
        

    }

    </script>


</body>
</html>